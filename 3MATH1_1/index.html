<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿·ä½ å†°é€²åŒ–ï¼šåˆ†æ•¸ç‰¹è¨“</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: #E0F7FA; /* æ·¡è—è‰²èƒŒæ™¯ */
            background-image: 
                radial-gradient(#B2EBF2 15%, transparent 15%),
                radial-gradient(#B2EBF2 15%, transparent 15%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        /* --- å·¦å´ï¼šå¯¶å¯å¤¢å±•ç¤ºå€ (ä½” 40%) --- */
        .left-panel {
            width: 40%;
            height: 100%;
            background: linear-gradient(135deg, #4FC3F7 0%, #0288D1 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 8px solid #FFF;
            position: relative;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            z-index: 2;
        }

        .poke-img-container {
            width: 80%;
            height: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
            border: 6px solid #FFF;
        }

        .poke-img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .poke-info {
            text-align: center;
            color: #FFF;
            margin-top: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .poke-name {
            font-size: 42px;
            font-weight: 900;
            color: #E1F5FE;
            margin: 0;
        }

        .level-indicator {
            font-size: 20px;
            color: #01579B;
            margin-top: 15px;
            background: #B3E5FC;
            padding: 6px 20px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 0 #0277BD;
        }

        /* --- å³å´ï¼šéŠæˆ²å€ (ä½” 60%) --- */
        .right-panel {
            width: 60%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .game-header {
            padding: 20px 30px;
            background: #29B6F6;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #0288D1;
        }

        .header-title {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 1px;
        }

        .progress-text {
            font-size: 18px;
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 12px;
            font-weight: bold;
        }

        /* éŠæˆ²ä¸»è¦å…§å®¹å€ */
        .game-content {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* é¡Œç›®æ¡† */
        .question-box {
            background: #FFF;
            width: 95%;
            padding: 25px;
            border-radius: 20px;
            border: 4px solid #81D4FA;
            box-shadow: 0 8px 0 #4FC3F7;
            text-align: left;
            font-size: 22px;
            color: #01579B;
            font-weight: bold;
            line-height: 1.8;
            position: relative;
            animation: fadeIn 0.5s;
        }

        /* åˆ†æ•¸é¡¯ç¤ºæ¨£å¼ */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
            font-size: 0.9em;
        }
        .fraction sup {
            display: block;
            border-bottom: 2px solid #01579B;
            padding: 0 2px;
            font-size: 0.8em;
        }
        .fraction sub {
            display: block;
            font-size: 0.8em;
        }

        /* é¸é …æŒ‰éˆ•å€ */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 95%;
        }

        .option-btn {
            background: white;
            border: 3px solid #4FC3F7;
            color: #0277BD;
            font-size: 20px;
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.1s;
            font-weight: bold;
            box-shadow: 0 5px 0 #0288D1;
            font-family: "Noto Sans TC", sans-serif;
            text-align: left;
            display: flex;
            align-items: center;
        }

        .option-btn:hover {
            background-color: #E1F5FE;
            transform: translateY(-2px);
        }

        .option-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* éŒ¯èª¤æç¤º Modal (åªé¡¯ç¤ºè§£æ) */
        .feedback-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .feedback-content {
            background: white;
            width: 85%;
            max-width: 600px;
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            border-top: 10px solid #0288D1;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        }
        .feedback-title { color: #0277BD; font-size: 32px; margin-bottom: 20px; font-weight: 900; }
        .feedback-msg { 
            font-size: 20px; 
            color: #333; 
            line-height: 1.6; 
            margin-bottom: 30px; 
            background: #E1F5FE; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: left;
            border-left: 5px solid #0288D1;
        }
        .feedback-btn {
            background: #03A9F4; color: white; border: none; padding: 12px 40px;
            font-size: 22px; border-radius: 50px; cursor: pointer; font-weight:bold;
            box-shadow: 0 5px 0 #0277BD;
        }
        .feedback-btn:active { transform: translateY(4px); box-shadow: none; }

        /* éŒ¯é¡Œå›é¡§é é¢ */
        .review-screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .review-card {
            background: white;
            width: 90%;
            max-width: 800px;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            border-left: 8px solid #FF7043;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .review-q { font-weight: bold; font-size: 18px; color: #333; margin-bottom: 10px; }
        .review-wrong { color: #D32F2F; font-size: 16px; margin-bottom: 5px; }
        .review-exp { font-size: 16px; color: #555; background: #FFF3E0; padding: 10px; border-radius: 8px; margin-top: 10px;}

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* RWD */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .left-panel { width: 100%; height: 35vh; border-right: none; border-bottom: 6px solid #FFF; }
            .right-panel { width: 100%; height: 65vh; }
            .poke-name { font-size: 32px; }
            .game-content { padding: 15px; }
            .question-box { font-size: 18px; padding: 15px; }
            .options-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="left-panel" id="left-panel">
        <div class="poke-img-container">
            <img src="" id="poke-img" class="poke-img">
        </div>
        <div class="poke-info">
            <h1 class="poke-name" id="poke-name">è¿·ä½ å†°</h1>
            <div class="level-indicator" id="stage-indicator">éšæ®µä¸€ï¼šåˆçµå†°éœœ</div>
        </div>
    </div>

    <div class="right-panel">
        <div class="game-header">
            <div class="header-title">åˆ†æ•¸ç‰¹è¨“</div>
            <div class="progress-text" id="progress-text">ç¬¬ 1 / 15 é¡Œ</div>
        </div>

        <div class="game-content" id="game-area">
            <div class="question-box" id="question-text">
                é¡Œç›®è¼‰å…¥ä¸­...
            </div>
            <div class="options-grid" id="options-grid">
                </div>
        </div>

        <div class="review-screen" id="review-area">
            <h2 style="color: #0277BD; font-size: 30px;">ğŸ§Š éŒ¯é¡Œå›é¡§å†°åº« ğŸ§Š</h2>
            <div id="review-list" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
            <button class="feedback-btn" onclick="location.reload()" style="margin: 30px;">å†æŒ‘æˆ°ä¸€æ¬¡</button>
        </div>
    </div>

    <div class="feedback-modal" id="feedback-modal">
        <div class="feedback-content">
            <div class="feedback-title">â„ï¸ çµå‡äº†ï¼(ç­”éŒ¯å›‰)</div>
            <div class="feedback-msg" id="feedback-text"></div>
            <button class="feedback-btn" onclick="closeModal()">å†è©¦ä¸€æ¬¡</button>
        </div>
    </div>

<script>
    // --- è³‡æ–™è™•ç†èˆ‡è¼”åŠ©å‡½å¼ ---
    
    // å°‡ \F(a,b) è½‰æ›ç‚º HTML åˆ†æ•¸æ ¼å¼
    function formatText(text) {
        return text.replace(/\\F\((\d+|â–¡|[\d\+\-\s]+),(\d+|â– |[\d\+\-\s]+)\)/g, function(match, n, d) {
            return `<span class="fraction"><sup>${n}</sup><sub>${d}</sub></span>`;
        });
    }

    // --- é¡Œç›®è³‡æ–™åº« (15é¡Œ) ---
    // Q4 é¸é …æ”¹ç‚ºæ–‡å­—æè¿°ä»¥æ›¿ä»£åœ–ç‰‡
    const rawQuestions = [
        {
            q: "ä¸€å¼µæµ·å ±ç´™å¹³åˆ†æˆ15ä»½ï¼Œç¾ç¾ç”¨æ‰\\F(5,15å¼µæµ·å ±ç´™ï¼Œå°è¯æ¯”ç¾ç¾å¤šç”¨æ‰äº†\\F(2,15å¼µï¼Œå°è¯ç”¨æ‰äº†å¤šå°‘å¼µæµ·å ±ç´™ï¼Ÿ",
            options: ["\\F(2,15å¼µ", "\\F(2,15å¼µ", "\\F(5,15å¼µ", "\\F(7,15å¼µ"],
            ansIndex: 3, 
            exp: "ç¾ç¾ç”¨äº† \\F(5,15ã€‚<br>å°è¯æ¯”ç¾ç¾å¤šç”¨ \\F(2,15ã€‚<br>æ‰€ä»¥å°è¯ç”¨äº†ï¼š\\F(5,15 ï¼‹ \\F(2,15 ï¼ \\F(7,15ã€‚"
        },
        {
            q: "å°‡ä¸€å¡Šè›‹ç³•å¹³åˆ†æˆ10ä»½ï¼Œç¾ç¾æ‹¿èµ°å…¶ä¸­3ä»½ï¼Œå°å¯§æ‹¿èµ°\\F(6,10å¡Šè›‹ç³•ï¼Œä»–å€‘å…±æ‹¿äº†å¤šå°‘å¡Šè›‹ç³•ï¼Ÿ",
            options: ["\\F(6,10å¡Š", "\\F(3,10å¡Š", "\\F(9,10å¡Š", "\\F(2,10å¡Š"],
            ansIndex: 2, 
            exp: "ç¾ç¾æ‹¿èµ°3ä»½ï¼Œå°±æ˜¯ \\F(3,10 å¡Šã€‚<br>å…±æ‹¿äº†ï¼š\\F(3,10 ï¼‹ \\F(6,10 ï¼ \\F(9,10ã€‚"
        },
        {
            q: "å†°ç®±è£¡æœ‰ä¸€äº›éº¥èŒ¶ï¼Œè‘³è‘³å–äº†\\F(3,9ç“¶éº¥èŒ¶ï¼Œé‚„å‰©ä¸‹\\F(1,9ç“¶ï¼Œå†°ç®±è£¡åŸä¾†æœ‰å¤šå°‘ç“¶éº¥èŒ¶ï¼Ÿ",
            options: ["\\F(4,9ç“¶", "\\F(3,9ç“¶", "\\F(2,9ç“¶", "\\F(1,9ç“¶"],
            ansIndex: 0, 
            exp: "å–æ‰çš„ ï¼‹ å‰©ä¸‹çš„ ï¼ åŸä¾†çš„ã€‚<br>\\F(3,9 ï¼‹ \\F(1,9 ï¼ \\F(4,9ã€‚"
        },
        {
            q: "\\F(2,8ï¼‹\\F(4,8çš„ç­”æ¡ˆæ˜¯\\F(6,8ï¼Œä¸‹é¢å“ªä¸€å€‹åˆ†æ•¸æ¯”å®ƒå°ï¼Ÿ", // ä¿®æ”¹é¡Œç›®ä»¥é©æ‡‰ç„¡åœ–ç‰‡
            options: ["\\F(1,8", "\\F(7,8", "\\F(6,8", "\\F(8,8"],
            ansIndex: 0, 
            exp: "\\F(2,8 ï¼‹ \\F(4,8 ï¼ \\F(6,8ã€‚<br>é¡Œç›®å•æ¯”å®ƒå°çš„åˆ†æ•¸ã€‚<br>â‘  \\F(1,8 (å°æ–¼)<br>â‘¡ \\F(7,8 (å¤§æ–¼)<br>â‘¢ \\F(6,8 (ç­‰æ–¼)<br>â‘£ \\F(8,8 (å¤§æ–¼)<br>æ‰€ä»¥é¸â‘ ã€‚"
        },
        {
            q: "åª½åª½åˆ°è¶…å¸‚è²·äº†ä¸€ç›’12é¡†çš„é›è›‹ï¼Œåœ¨å›å®¶é€”ä¸­ä¸å°å¿ƒæ‰“ç ´3é¡†ï¼Œé‚„å‰©ä¸‹å¹¾ç›’å®Œå¥½çš„é›è›‹ï¼Ÿ",
            options: ["\\F(3,12ç›’", "\\F(5,12ç›’", "\\F(7,12ç›’", "\\F(9,12ç›’"],
            ansIndex: 3, 
            exp: "æ‰“ç ´3é¡†ï¼Œå‰©ä¸‹ 12 ï¼ 3 ï¼ 9 é¡†ã€‚<br>ä¸€ç›’æœ‰12é¡†ï¼Œæ‰€ä»¥å‰©ä¸‹ \\F(9,12 ç›’ã€‚"
        },
        {
            q: "ä¸€åŒ…å·§å…‹åŠ›æœ‰11é¡†ï¼Œå°å­Ÿåƒäº†3é¡†ï¼Œå‰©é¤˜çš„çµ¦é™½é™½åƒï¼Œé™½é™½èƒ½åƒåˆ°å¹¾åŒ…çš„å·§å…‹åŠ›ï¼Ÿ",
            options: ["8åŒ…", "3åŒ…", "\\F(3,8åŒ…", "\\F(8,11åŒ…"],
            ansIndex: 3, 
            exp: "å‰©ä¸‹ 11 ï¼ 3 ï¼ 8 é¡†ã€‚<br>ä¸€åŒ…æœ‰11é¡†ï¼Œæ‰€ä»¥æ˜¯ \\F(8,11 åŒ…ã€‚"
        },
        {
            q: "ä¸‹é¢å“ªä¸€å€‹é¸é …ä¸­çš„ç®—å¼ç­”æ¡ˆæœ€å¤§ï¼Ÿ",
            options: ["\\F(6,10ï¼\\F(2,10", "\\F(5,10ï¼\\F(3,10", "\\F(4,10ï¼\\F(4,10", "\\F(6,10ï¼\\F(3,10"],
            ansIndex: 0, 
            exp: "â‘  \\F(4,10 (æœ€å¤§)<br>â‘¡ \\F(2,10<br>â‘¢ 0<br>â‘£ \\F(3,10"
        },
        {
            q: "ä¸‹é¢å“ªä¸€å€‹é¸é …ä¸­çš„ç®—å¼ç­”æ¡ˆæœ€å°ï¼Ÿ",
            options: ["\\F(5,9ï¼\\F(2,9", "\\F(4,9ï¼\\F(3,9", "\\F(6,9ï¼\\F(2,9", "\\F(7,9ï¼\\F(1,9"],
            ansIndex: 1, 
            exp: "â‘  \\F(3,9<br>â‘¡ \\F(1,9 (æœ€å°)<br>â‘¢ \\F(4,9<br>â‘£ \\F(6,9"
        },
        {
            q: "ä¸‹é¢å“ªä¸€å€‹é¸é …ä¸­çš„ç®—å¼ç­”æ¡ˆæœ€å°ï¼Ÿ",
            options: ["\\F(5,8ï¼\\F(3,8", "\\F(6,8ï¼\\F(3,8", "\\F(7,8ï¼\\F(6,8", "1ï¼\\F(8,8"],
            ansIndex: 3, 
            exp: "â‘  \\F(2,8<br>â‘¡ \\F(3,8<br>â‘¢ \\F(1,8<br>â‘£ 1ï¼1ï¼0 (æœ€å°)"
        },
        {
            q: "å“èŠ³å¯«è€ƒå·ï¼Œä¸å°å¿ƒå°‡é¡Œç›®çš„åŠ æ•¸å¼„é«’ï¼Œè€ƒå·ä¸Šè¢«åŠ æ•¸æ˜¯\\F(3,7ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯1ï¼ŒåŸæœ¬é¡Œç›®çš„åŠ æ•¸æ˜¯å¤šå°‘ï¼Ÿ",
            options: ["\\F(2,7", "\\F(3,7", "\\F(4,7", "\\F(5,7"],
            ansIndex: 2, 
            exp: "1 å°±æ˜¯ \\F(7,7ã€‚<br>\\F(3,7 ï¼‹ ( ) ï¼ \\F(7,7ã€‚<br>æ‰€ä»¥åŠ æ•¸æ˜¯ \\F(4,7ã€‚"
        },
        {
            q: "å»ºè±ªå¯«è€ƒå·ï¼Œä¸å°å¿ƒå°‡é¡Œç›®çš„è¢«åŠ æ•¸å¼„é«’ï¼Œè€ƒå·ä¸ŠåŠ æ•¸æ˜¯\\F(6,12ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯\\F(7,12ï¼ŒåŸæœ¬é¡Œç›®çš„è¢«åŠ æ•¸æ˜¯å¤šå°‘ï¼Ÿ",
            options: ["\\F(12,5", "\\F(7,12", "\\F(6,12", "\\F(1,12"],
            ansIndex: 3, 
            exp: "( ) ï¼‹ \\F(6,12 ï¼ \\F(7,12ã€‚<br>æ‰€ä»¥è¢«åŠ æ•¸æ˜¯ \\F(1,12ã€‚"
        },
        {
            q: "\\F(â–¡,9ï¼\\F(2,9ï¼\\F(4,9ï¼Œâ–¡è¡¨ç¤ºçš„æ•¸å­—æ˜¯å¤šå°‘ï¼Ÿ",
            options: ["9", "6", "4", "2"],
            ansIndex: 1, 
            exp: "â–¡ ï¼ 2 ï¼ 4ã€‚<br>æ‰€ä»¥ â–¡ ï¼ 6ã€‚"
        },
        {
            q: "\\F(7,â–¡ï¼\\F(2,â–¡ï¼\\F(5,10ï¼Œâ–¡æ˜¯ä¸€æ¨£çš„æ•¸ï¼Œâ–¡è¡¨ç¤ºçš„æ•¸å­—æ˜¯å¤šå°‘ï¼Ÿ",
            options: ["9", "10", "12", "13"],
            ansIndex: 1, 
            exp: "åˆ†æ•¸ç›¸æ¸›åˆ†æ¯ä¸è®Šã€‚<br>æ—¢ç„¶çµæœçš„åˆ†æ¯æ˜¯ 10ï¼Œé‚£éº¼å‰é¢çš„åˆ†æ¯ â–¡ ä¹Ÿä¸€å®šæ˜¯ 10ã€‚"
        },
        {
            q: "1ï¼\\F(2,8ï¼\\F(â– ,8ï¼Œâ– è¡¨ç¤ºçš„æ•¸å­—æ˜¯å¤šå°‘ï¼Ÿ",
            options: ["2", "3", "6", "8"],
            ansIndex: 2, 
            exp: "1 ç­‰æ–¼ \\F(8,8ã€‚<br>\\F(8,8 ï¼ \\F(2,8 ï¼ \\F(6,8ã€‚<br>æ‰€ä»¥ â–  æ˜¯ 6ã€‚"
        },
        {
            q: "ä¸‹é¢å“ªä¸€å€‹é¸é …è¨ˆç®—å¾Œçš„ç­”æ¡ˆæ˜¯0ï¼Ÿ",
            options: ["\\F(7,8ï¼1å€‹\\F(1,8", "\\F(3,6ï¼å…­åˆ†ä¹‹ä¸‰", "\\F(5,7ï¼\\F(3,7", "\\F(2,6ï¼‹å…­åˆ†ä¹‹äºŒ"],
            ansIndex: 1, 
            exp: "â‘  \\F(6,8<br>â‘¡ \\F(3,6 ï¼ \\F(3,6 ï¼ 0 (æ­£ç¢º)<br>â‘¢ \\F(2,7<br>â‘£ \\F(4,6"
        }
    ];

    // éŠæˆ²ç‹€æ…‹è®Šæ•¸
    let currentQuestions = [];
    let currentIndex = 0;
    let wrongQuestionsLog = []; // è¨˜éŒ„ç¬¬ä¸€æ¬¡ç­”éŒ¯çš„é¡Œç›®
    let hasErrorInCurrentQuestion = false; 

    // é€²åŒ–è¨­å®š
    const stages = [
        { name: "è¿·ä½ å†°", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/582.png", title: "éšæ®µä¸€ï¼šåˆçµå†°éœœ" },
        { name: "å¤šå¤šå†°", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/583.png", title: "éšæ®µäºŒï¼šå¯’æ°£é€¼äºº" },
        { name: "é›™å€å¤šå¤šå†°", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/584.png", title: "éšæ®µä¸‰ï¼šçµ•å°é›¶åº¦" }
    ];

    window.onload = function() {
        startGame();
    };

    function startGame() {
        // æ´—ç‰Œ
        currentQuestions = [...rawQuestions].sort(() => 0.5 - Math.random());
        currentIndex = 0;
        wrongQuestionsLog = [];
        hasErrorInCurrentQuestion = false;
        
        document.getElementById('game-area').style.display = 'flex';
        document.getElementById('review-area').style.display = 'none';
        
        updatePokemon(0);
        loadQuestion();
    }

    function updatePokemon(stageIndex) {
        const data = stages[stageIndex];
        document.getElementById('poke-name').innerText = data.name;
        document.getElementById('stage-indicator').innerText = data.title;
        document.getElementById('poke-img').src = data.img;
        
        if (stageIndex > 0) {
            const img = document.getElementById('poke-img');
            img.style.filter = "brightness(100) drop-shadow(0 0 20px white)";
            img.style.transform = "scale(1.2)";
            setTimeout(() => {
                img.style.filter = "drop-shadow(0 10px 15px rgba(0,0,0,0.2))";
                img.style.transform = "scale(1)";
                launchConfetti();
            }, 600);
        }
    }

    function loadQuestion() {
        // 0-4é¡Œ: éšæ®µä¸€, 5-9é¡Œ: éšæ®µäºŒ, 10-14é¡Œ: éšæ®µä¸‰
        let stage = 0;
        if (currentIndex >= 5) stage = 1;
        if (currentIndex >= 10) stage = 2;
        
        // å¦‚æœå‰›è·¨å…¥æ–°éšæ®µ
        if ((currentIndex === 5 || currentIndex === 10) && !hasErrorInCurrentQuestion) {
            updatePokemon(stage);
        } else if (currentIndex === 0) {
            updatePokemon(0);
        }

        document.getElementById('progress-text').innerText = `ç¬¬ ${currentIndex + 1} / 15 é¡Œ`;

        const qData = currentQuestions[currentIndex];
        
        document.getElementById('question-text').innerHTML = formatText(qData.q);
        
        const grid = document.getElementById('options-grid');
        grid.innerHTML = "";
        
        qData.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = formatText(opt);
            btn.onclick = () => checkAnswer(idx, btn);
            grid.appendChild(btn);
        });
    }

    function checkAnswer(selectedIndex, btn) {
        const qData = currentQuestions[currentIndex];
        
        if (selectedIndex === qData.ansIndex) {
            // ç­”å°
            btn.style.backgroundColor = "#B3E5FC";
            btn.style.border = "3px solid #0288D1";
            
            setTimeout(() => {
                hasErrorInCurrentQuestion = false;
                currentIndex++;
                
                if (currentIndex >= currentQuestions.length) {
                    showReviewScreen();
                } else {
                    loadQuestion();
                }
            }, 600);
        } else {
            // ç­”éŒ¯
            if (!hasErrorInCurrentQuestion) {
                // è¨˜éŒ„éŒ¯é¡Œï¼ŒåŒ…å«ä½¿ç”¨è€…é¸äº†ä»€éº¼(é€™è£¡è¨˜éŒ„ç•¶æ™‚çš„é¸é …æ–‡å­—)
                wrongQuestionsLog.push({
                    ...qData,
                    wrongChoice: qData.options[selectedIndex]
                });
                hasErrorInCurrentQuestion = true;
            }
            
            // é¡¯ç¤ºè§£æè¦–çª— (ä¸é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ)
            showErrorModal(qData.exp);
        }
    }

    function showErrorModal(expText) {
        const modal = document.getElementById('feedback-modal');
        const text = document.getElementById('feedback-text');
        
        text.innerHTML = `
            <strong>è§£ææç¤ºï¼š</strong><br>
            ${formatText(expText)}
        `;
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('feedback-modal').style.display = 'none';
    }

    function showReviewScreen() {
        document.getElementById('left-panel').style.display = 'none';
        document.getElementById('game-area').style.display = 'none';
        document.getElementById('progress-text').innerText = "ç‰¹è¨“å®Œæˆ";
        
        const reviewArea = document.getElementById('review-area');
        const reviewList = document.getElementById('review-list');
        reviewArea.style.display = 'flex';
        reviewList.innerHTML = "";

        if (wrongQuestionsLog.length === 0) {
            reviewList.innerHTML = "<h3 style='color:#01579B;'>å¤ªæ£’äº†ï¼å…¨å°ï¼æ²’æœ‰éŒ¯é¡Œéœ€è¦è¤‡ç¿’ã€‚</h3>";
            launchConfetti();
        } else {
            reviewList.innerHTML = `<p style='font-size:18px;'>ä½ åœ¨é€™æ¬¡ç‰¹è¨“ä¸­ï¼Œå…±æœ‰ <span style='color:red;font-weight:bold;'>${wrongQuestionsLog.length}</span> é¡Œåˆæ¬¡å›ç­”éŒ¯èª¤ï¼š</p>`;
            
            wrongQuestionsLog.forEach((qData, index) => {
                const card = document.createElement('div');
                card.className = 'review-card';
                card.innerHTML = `
                    <div class="review-q">é¡Œç›®ï¼š${formatText(qData.q)}</div>
                    <div class="review-wrong">ä½ èª¤é¸äº†ï¼š${formatText(qData.wrongChoice)}</div>
                    <div class="review-exp"><strong>è§£æï¼š</strong><br>${formatText(qData.exp)}</div>
                `;
                reviewList.appendChild(card);
            });
        }
        
        launchConfetti();
    }

    function launchConfetti() {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#4FC3F7', '#B3E5FC', '#FFFFFF']
        });
    }
</script>

</body>
</html>
