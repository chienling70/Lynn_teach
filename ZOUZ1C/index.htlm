<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¦™è›™ç¨®å­é€²åŒ–ï¼šèªè©å¡«ç©ºç‰¹è¨“</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: #1b5e20; /* æ·±ç¶ è‰²èƒŒæ™¯ */
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        /* --- å·¦å´ï¼šå¯¶å¯å¤¢å±•ç¤ºå€ (ä½” 40%) --- */
        .left-panel {
            width: 40%;
            height: 100%;
            background: linear-gradient(135deg, #2e7d32 0%, #66bb6a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 5px solid #81c784;
            position: relative;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            z-index: 2;
        }

        .poke-img-container {
            width: 90%;
            height: 60%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .poke-img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(144, 238, 144, 0.6));
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .poke-info {
            text-align: center;
            color: #fff;
            margin-top: 20px;
        }

        .poke-name {
            font-size: 40px;
            font-weight: 900;
            color: #c8e6c9;
            text-shadow: 2px 2px 0 #1b5e20;
            margin: 0;
        }

        .level-indicator {
            font-size: 20px;
            color: #e8f5e9;
            margin-top: 10px;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #a5d6a7;
        }

        /* --- å³å´ï¼šéŠæˆ²å€ (ä½” 60%) --- */
        .right-panel {
            width: 60%;
            height: 100%;
            background-color: #f1f8e9; /* æ·ºè‰ç¶  */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .game-header {
            padding: 20px;
            background: #43a047;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-char {
            font-size: 32px;
            font-weight: bold;
        }

        .instruction {
            font-size: 16px;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 10px;
        }

        /* éŠæˆ²æ²å‹•å€ */
        .game-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* é¡Œç›®å®¹å™¨ (å¥å­æ¡†) */
        .targets-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .sentence-box {
            background: #fff;
            border: 2px solid #a5d6a7;
            border-radius: 15px;
            padding: 15px;
            font-size: 20px;
            color: #33691e;
            line-height: 1.8;
            position: relative;
            box-shadow: 0 2px 0 #81c784;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        /* æŒ–ç©ºå€åŸŸ (Drop Zone) */
        .drop-zone {
            display: inline-block;
            min-width: 100px;
            height: 36px;
            background: #e8f5e9;
            border-bottom: 3px solid #43a047;
            margin: 0 5px;
            vertical-align: middle;
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s;
            padding: 0 10px;
        }

        /* ç­”å°æ¨£å¼ */
        .drop-zone.correct {
            border: none;
            background-color: #43a047;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 10px #4caf50;
            line-height: 36px;
            animation: popIn 0.3s;
        }

        /* ç­”éŒ¯æ¨£å¼ (ç¬é–“) */
        .drop-zone.wrong-flash {
            animation: shake 0.5s;
            background-color: #ffcdd2;
            border-color: #d32f2f;
        }

        /* é¸é …å€ (èªè©) */
        .options-area {
            background: rgba(76, 175, 80, 0.1);
            border: 2px dashed #43a047;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            min-height: 100px;
        }

        .draggable-item {
            background: #fff;
            color: #2e7d32;
            border: 2px solid #2e7d32;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 22px;
            font-weight: bold;
            cursor: grab;
            box-shadow: 0 4px 0 #1b5e20;
            transition: transform 0.1s;
            touch-action: none;
            z-index: 100;
        }

        .draggable-item:active {
            cursor: grabbing;
            transform: scale(1.1);
            background: #c8e6c9;
        }

        /* æŒ‰éˆ• */
        .next-btn {
            margin: 0 auto;
            padding: 15px 60px;
            font-size: 24px;
            background: #ffeb3b; /* é®®é»ƒè‰²æŒ‰éˆ• */
            color: #333;
            border: 4px solid #fff;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #fbc02d;
            display: none;
            animation: pulseBtn 1.5s infinite;
        }

        /* éŒ¯èª¤æç¤º Modal */
        .error-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .error-content {
            background: white;
            width: 80%;
            max-width: 500px;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border-top: 10px solid #d32f2f;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .error-title { color: #d32f2f; font-size: 32px; margin-bottom: 20px; font-weight: bold; }
        .error-msg { font-size: 20px; color: #333; line-height: 1.6; margin-bottom: 30px; text-align: left; background:#fafafa; padding:15px; border-radius:10px; border-left: 5px solid #d32f2f;}
        .error-btn {
            background: #d32f2f; color: white; border: none; padding: 15px 40px;
            font-size: 22px; border-radius: 50px; cursor: pointer; font-weight:bold;
            box-shadow: 0 4px 0 #b71c1c;
        }

        /* çµæŸç•«é¢ */
        .end-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 3000; color: white;
        }

        /* å‹•ç•« */
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes evolveFlash { 
            0% { filter: brightness(1) drop-shadow(0 0 10px #66bb6a); } 
            50% { filter: brightness(100) drop-shadow(0 0 50px white); } 
            100% { filter: brightness(1) drop-shadow(0 0 10px #66bb6a); } 
        }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* RWD èª¿æ•´ */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .left-panel { width: 100%; height: 35vh; border-right: none; border-bottom: 5px solid #81c784; }
            .right-panel { width: 100%; height: 65vh; }
            .poke-name { font-size: 28px; }
            .game-header { padding: 10px; }
            .current-char { font-size: 24px; }
            .sentence-box { font-size: 16px; }
        }
    </style>
</head>
<body>

    <div class="left-panel">
        <div class="poke-img-container">
            <img src="" id="poke-img" class="poke-img">
        </div>
        <div class="poke-info">
            <h1 class="poke-name" id="poke-name">å¦™è›™ç¨®å­</h1>
            <div class="level-indicator" id="stage-indicator">ç¬¬ 1 / 8 é—œ</div>
        </div>
    </div>

    <div class="right-panel">
        <div class="game-header">
            <div class="current-char" id="level-header">ç¬¬ä¸€é—œï¼šæ…¶</div>
            <div class="instruction">å°‡èªè©æ‹–å…¥æ­£ç¢ºçš„ç©ºæ ¼ä¸­ (ç­”éŒ¯éœ€é‡ä¾†)</div>
        </div>

        <div class="game-content">
            <div class="targets-grid" id="targets-grid">
                </div>

            <div class="options-area" id="options-area">
                </div>

            <button class="next-btn" id="next-btn" onclick="nextLevel()">é€²åŒ–ï¼ä¸‹ä¸€é—œ</button>
        </div>
    </div>

    <div class="error-modal" id="error-modal">
        <div class="error-content">
            <div class="error-title">ğŸƒ å“å‘€ï¼Œç­”éŒ¯äº†ï¼</div>
            <div class="error-msg" id="error-msg-text"></div>
            <button class="error-btn" onclick="resetLevel()">é‡æ–°ç‰¹è¨“</button>
        </div>
    </div>

    <div class="end-screen" id="end-screen">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/10033.png" style="width:320px; filter: drop-shadow(0 0 20px #66bb6a);">
        <h1 style="color:#a5d6a7; font-size:40px; margin-top:20px;">ç‰¹è¨“å®Œå…¨åˆ¶éœ¸ï¼</h1>
        <h2>è¶…ç´šå¦™è›™èŠ± è¦ºé†’ï¼</h2>
        <button class="next-btn" style="display:block; background:#fff; color:#1b5e20; margin-top:30px;" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
    </div>

<script>
    // --- éŠæˆ²è³‡æ–™åº« (8é—œ) ---
    const levels = [
        {
            char: "æ…¶",
            pairs: [
                { word: "æ…¶è³€", sentence: "å¤§å®¶ä¸€èµ·_____å¥¶å¥¶çš„å…«åæ­²å¤§å£½ã€‚" },
                { word: "å–œæ…¶", sentence: "éå¹´æ™‚ï¼Œå®¶è£¡è²¼æ»¿äº†ç´…è‰²çš„æ˜¥è¯ï¼Œçœ‹èµ·ä¾†å¾ˆ_____ã€‚" },
                { word: "æ…¶å…¸", sentence: "åœ‹æ…¶æ—¥æ™‚ï¼Œç¸½çµ±åºœå‰æœƒèˆ‰è¾¦ç››å¤§çš„_____ã€‚" },
                { word: "æ…¶å¹¸", sentence: "é‚„å¥½æˆ‘æœ‰å¸¶å‚˜ï¼Œ_____æ²’è¢«é€™å ´å¤§é›¨æ·‹æ¿•ã€‚" }
            ]
        },
        {
            char: "æ‡·",
            pairs: [
                { word: "æ‡·å¿µ", sentence: "æˆ‘å¾ˆ_____ä»¥å‰å¹¼å…’åœ’çš„è€å¸«å’ŒåŒå­¸ã€‚" },
                { word: "æ‡·æŠ±", sentence: "å‰›å‡ºç”Ÿçš„å¼Ÿå¼Ÿèººåœ¨åª½åª½_____è£¡ï¼Œçœ‹èµ·ä¾†å¾ˆå¹¸ç¦ã€‚" },
                { word: "æ‡·ç–‘", sentence: "å¤§å®¶éƒ½å¾ˆèª å¯¦ï¼Œæˆ‘ä¸è©²_____é€™ä»¶äº‹æ˜¯èª°åšçš„ã€‚" },
                { word: "é—œæ‡·", sentence: "è€å¸«å¸¸å¸¸æ•™å°æˆ‘å€‘è¦_____ç¨å±…çš„è€äººã€‚" },
                { word: "é‡‹æ‡·", sentence: "ç¶“éåª½åª½çš„é–‹å°ï¼Œä»–çµ‚æ–¼å°è¼¸æ‰æ¯”è³½é€™ä»¶äº‹_____äº†ã€‚" }
            ]
        },
        {
            char: "ç¥¥",
            pairs: [
                { word: "å‰ç¥¥", sentence: "æ©˜å­ä»£è¡¨_____å¦‚æ„ï¼Œéå¹´å¤§å®¶éƒ½è¦åƒã€‚" },
                { word: "ç¥¥å’Œ", sentence: "é„‰ä¸‹çš„ç”Ÿæ´»æ°£æ°›_____ï¼Œè®“äººæ„Ÿåˆ°å¾ˆæ”¾é¬†ã€‚" },
                { word: "æ…ˆç¥¥", sentence: "é„°å±…çš„è€å¥¶å¥¶å¾ˆ_____ï¼Œå¸¸å¸¸è«‹æˆ‘å€‘åƒç³–æœã€‚" },
                { word: "ç¥¥ç‘", sentence: "å¤ä»£äººèªç‚ºçœ‹åˆ°é³³å‡°æ˜¯_____çš„è±¡å¾µã€‚" },
                { word: "ä¸ç¥¥", sentence: "çƒé›²å¯†å¸ƒåˆç‹‚é¢¨å¤§ä½œï¼Œæœ‰ä¸€ç¨®_____çš„é æ„Ÿã€‚" }
            ]
        },
        {
            char: "å„€",
            pairs: [
                { word: "å„€å¼", sentence: "æ¯é€±çš„å‡æ——_____ï¼Œå…¨æ ¡åŒå­¸éƒ½è¦åƒåŠ ã€‚" },
                { word: "ç¦®å„€", sentence: "åƒé£¯æ™‚ä¸æ•²ç¢—ç­·ï¼Œæ˜¯åŸºæœ¬çš„é¤æ¡Œ_____ã€‚" },
                { word: "å„€å™¨", sentence: "è‡ªç„¶èª²æ™‚ï¼Œæˆ‘å€‘ç”¨ç§‘å­¸_____è§€å¯Ÿæ˜†èŸ²ã€‚" },
                { word: "å¸å„€", sentence: "_____ç«™åœ¨è‡ºä¸Šï¼Œå®£å¸ƒé‹å‹•æœƒæ­£å¼é–‹å§‹ã€‚" },
                { word: "å„€æ…‹", sentence: "å§Šå§Šçš„_____å„ªé›…ï¼Œåå§¿ç¸½æ˜¯å¾ˆç«¯æ­£ã€‚" }
            ]
        },
        {
            char: "åº",
            pairs: [
                { word: "é †åº", sentence: "è«‹å¤§å®¶ä¾ç…§æ’éšŠçš„_____ä¸Šè»Šï¼Œä¸è¦æ¨æ“ ã€‚" },
                { word: "ç§©åº", sentence: "åœ–æ›¸é¤¨è£¡è¦ä¿æŒ_____ï¼Œä¸èƒ½å¤§è²å–§å˜©ã€‚" },
                { word: "ç¨‹åº", sentence: "å€Ÿæ›¸çš„æ™‚å€™ï¼Œè¦å…ˆå®Œæˆåˆ·æ¢ç¢¼çš„_____ã€‚" },
                { word: "åºå¹•", sentence: "ç²¾å½©çš„é­”è¡“è¡¨æ¼”å³å°‡æ‹‰é–‹_____ã€‚" },
                { word: "è‡ªåº", sentence: "ä½œè€…åœ¨é€™æœ¬æ›¸çš„_____ä¸­ï¼Œå¯«ä¸‹äº†å‰µä½œçš„å¿ƒæƒ…ã€‚" }
            ]
        },
        {
            char: "æ¯«",
            pairs: [
                { word: "çµ²æ¯«", sentence: "ä»–æº–å‚™å¾—å¾ˆå……åˆ†ï¼Œå°æ˜å¤©çš„è€ƒè©¦_____ä¸æ„Ÿåˆ°ç·Šå¼µã€‚" },
                { word: "æ®æ¯«", sentence: "æ›¸æ³•æ¯”è³½æ™‚ï¼Œè¨±å¤šé«˜æ‰‹ç¾å ´_____å¯«å¤§å­—ã€‚" },
                { word: "åˆ†æ¯«", sentence: "é€™å…©ä½é¸æ‰‹è·‘å¾—ä¸€æ¨£å¿«ï¼Œæ™‚é–“å·®è·åªæœ‰_____ã€‚" },
                { word: "æ¯«ç„¡", sentence: "æˆ‘å°é€™é“å›°é›£çš„æ•¸å­¸é¡Œ_____é ­ç·’ã€‚" }
            ]
        },
        {
            char: "æŒ¨",
            pairs: [
                { word: "æŒ¨æ‰“", sentence: "å› ç‚ºæˆ‘ä¸è½è©±åˆäº‚è·‘ï¼Œå·®é»_____ã€‚" },
                { word: "æŒ¨ç½µ", sentence: "å¼Ÿå¼Ÿæ‰“ç ´äº†èŠ±ç“¶ï¼Œå¾ˆæ€•å›å®¶æœƒ_____ã€‚" },
                { word: "æŒ¨é¤“", sentence: "é‚£éš»æµæµªç‹—åœ¨è·¯é‚Š_____å—å‡ï¼Œçœ‹èµ·ä¾†å¥½å¯æ†ã€‚" }
            ]
        },
        {
            char: "å‰",
            pairs: [
                { word: "å‰åˆ©", sentence: "éå¹´è¦èªª_____è©±ï¼Œå¤§å®¶æ‰æœƒé–‹å¿ƒã€‚" },
                { word: "å‰ç¥¥", sentence: "é€™å¹…ç•«ç•«äº†_____çš„åœ–æ¡ˆï¼Œå¾ˆé©åˆæ›åœ¨å®¢å»³ã€‚" },
                { word: "å‰æ™‚", sentence: "æ—¢ç„¶_____å·²åˆ°ï¼Œå©šç¦®å°±è¶•å¿«é–‹å§‹å§ï¼" },
                { word: "å‰æ—¥", sentence: "ä»Šå¤©æ˜¯é»ƒé“_____ï¼Œè¨±å¤šäººéƒ½é¸åœ¨ä»Šå¤©çµå©šã€‚" }
            ]
        }
    ];

    // --- å¦™è›™ç¨®å­é€²åŒ–è¨­å®š ---
    const stages = [
        // Bulbasaur ID 1
        { name: "å¦™è›™ç¨®å­", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1.png" },
        // Ivysaur ID 2
        { name: "å¦™è›™è‰", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/2.png" },
        // Venusaur ID 3
        { name: "å¦™è›™èŠ±", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/3.png" }
    ];

    let currentLevelIdx = 0;
    let matchesFound = 0;

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        loadLevel();
    };

    function loadLevel() {
        const levelData = levels[currentLevelIdx];
        
        // æ›´æ–°æ¨™é¡Œ
        const chineseNums = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«"];
        document.getElementById('level-header').innerText = `ç¬¬${chineseNums[currentLevelIdx]}é—œï¼š${levelData.char}`;
        document.getElementById('stage-indicator').innerText = `ç¬¬ ${currentLevelIdx + 1} / 8 é—œ`;
        document.getElementById('next-btn').style.display = 'none';
        matchesFound = 0;

        // æ›´æ–°å·¦å´å¯¶å¯å¤¢
        updatePokemon();

        // å»ºç«‹é¡Œç›®å€ (Sentences)
        const targetsGrid = document.getElementById('targets-grid');
        targetsGrid.innerHTML = '';
        
        levelData.pairs.forEach(pair => {
            let sentenceBox = document.createElement('div');
            sentenceBox.className = 'sentence-box';
            
            // å°‡å¥å­ä¸­çš„ _____ æ›¿æ›ç‚ºæ”¾ç½®å€ div
            const parts = pair.sentence.split('_____');
            
            let part1 = document.createElement('span');
            part1.innerText = parts[0];
            sentenceBox.appendChild(part1);

            let dropZone = document.createElement('div');
            dropZone.className = 'drop-zone';
            dropZone.dataset.answer = pair.word; // ç­”æ¡ˆ
            // è¨»å†Šæ”¾ç½®äº‹ä»¶
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            sentenceBox.appendChild(dropZone);

            let part2 = document.createElement('span');
            part2.innerText = parts[1];
            sentenceBox.appendChild(part2);
            
            targetsGrid.appendChild(sentenceBox);
        });

        // å»ºç«‹é¸é …å€ (Draggables)
        const optionsArea = document.getElementById('options-area');
        optionsArea.innerHTML = '';
        
        let shuffledPairs = [...levelData.pairs].sort(() => 0.5 - Math.random());
        
        shuffledPairs.forEach(pair => {
            let item = document.createElement('div');
            item.className = 'draggable-item';
            item.draggable = true;
            item.innerText = pair.word;
            
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('touchstart', handleTouchStart, {passive: false});
            item.addEventListener('touchmove', handleTouchMove, {passive: false});
            item.addEventListener('touchend', handleTouchEnd);

            optionsArea.appendChild(item);
        });
    }

    function updatePokemon() {
        const img = document.getElementById('poke-img');
        const nameEl = document.getElementById('poke-name');
        let stage = 0;
        
        // 0-1é—œ: å¦™è›™ç¨®å­ (2é—œ)
        // 2-4é—œ: å¦™è›™è‰ (3é—œ)
        // 5-7é—œ: å¦™è›™èŠ± (3é—œ)
        if (currentLevelIdx >= 2 && currentLevelIdx < 5) stage = 1;
        if (currentLevelIdx >= 5) stage = 2;

        if (img.src !== stages[stage].img) {
            img.classList.add('evolving');
            setTimeout(() => {
                img.src = stages[stage].img;
                nameEl.innerText = stages[stage].name;
                img.classList.remove('evolving');
            }, 500);
        } else {
            img.src = stages[stage].img;
            nameEl.innerText = stages[stage].name;
        }
    }

    // --- æ‹–æ›³é‚è¼¯ ---
    let draggedItem = null;

    function handleDragStart(e) {
        draggedItem = e.target;
        e.dataTransfer.setData('text/plain', e.target.innerText);
    }

    function handleDragOver(e) {
        e.preventDefault(); 
        if (!e.currentTarget.classList.contains('correct')) {
            e.currentTarget.style.backgroundColor = '#c8e6c9';
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        const box = e.currentTarget;
        if (!box.classList.contains('correct')) {
            box.style.backgroundColor = '#e8f5e9';
        }
        const word = e.dataTransfer.getData('text/plain');
        checkAnswer(box, word, draggedItem);
    }

    // --- è§¸æ§é‚è¼¯ ---
    let touchItem = null;

    function handleTouchStart(e) {
        e.preventDefault();
        touchItem = e.target;
        touchItem.style.position = 'fixed';
        touchItem.style.opacity = '0.8';
        touchItem.style.zIndex = '1000';
        const touch = e.touches[0];
        touchItem.style.left = (touch.clientX - touchItem.offsetWidth / 2) + 'px';
        touchItem.style.top = (touch.clientY - touchItem.offsetHeight / 2) + 'px';
    }

    function handleTouchMove(e) {
        if (!touchItem) return;
        e.preventDefault();
        const touch = e.touches[0];
        touchItem.style.left = (touch.clientX - touchItem.offsetWidth / 2) + 'px';
        touchItem.style.top = (touch.clientY - touchItem.offsetHeight / 2) + 'px';
    }

    function handleTouchEnd(e) {
        if (!touchItem) return;
        const touch = e.changedTouches[0];
        touchItem.style.display = 'none';
        let elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        touchItem.style.display = 'block';

        let box = elemBelow ? elemBelow.closest('.drop-zone') : null;

        if (box) {
            checkAnswer(box, touchItem.innerText, touchItem);
        } else {
            resetItemStyle(touchItem);
        }
        touchItem = null;
    }

    function resetItemStyle(item) {
        item.style.position = 'static';
        item.style.opacity = '1';
        item.style.zIndex = '100';
    }

    // --- æ ¸å¿ƒï¼šæª¢æŸ¥ç­”æ¡ˆ (åš´æ ¼æ¨¡å¼) ---
    function checkAnswer(box, userWord, itemEl) {
        if (box.classList.contains('correct')) {
            if(itemEl.style.position === 'fixed') resetItemStyle(itemEl);
            return;
        }

        const correctWord = box.dataset.answer;

        if (userWord === correctWord) {
            // --- ç­”å° ---
            box.innerText = userWord;
            box.classList.add('correct');
            itemEl.remove();
            
            matchesFound++;
            
            if (matchesFound === levels[currentLevelIdx].pairs.length) {
                launchConfetti();
                document.getElementById('next-btn').style.display = 'block';
            }

        } else {
            // --- ç­”éŒ¯ (è§¸ç™¼é‡ç½®) ---
            if(itemEl.style.position === 'fixed') resetItemStyle(itemEl);
            
            box.classList.add('wrong-flash');
            setTimeout(() => box.classList.remove('wrong-flash'), 500);

            // æŠ“å‡ºæ•´å¥é¡Œç›®
            const fullSentence = box.parentElement.innerText.replace("______", correctWord);

            showErrorReason(userWord, correctWord, fullSentence);
        }
    }

    function showErrorReason(userWord, correctWord, sentence) {
        const modal = document.getElementById('error-modal');
        const msgText = document.getElementById('error-msg-text');
        
        msgText.innerHTML = `
            ä½ é¸æ“‡äº†ï¼š<span style="color:#d32f2f; font-weight:bold;">${userWord}</span><br><br>
            ä½†é€™è£¡æ­£ç¢ºç­”æ¡ˆæ‡‰è©²æ˜¯ï¼š<span style="color:#2e7d32; font-weight:bold;">${correctWord}</span><br><br>
            <div style="font-size:16px; background:#e8f5e9; padding:10px; border-radius:5px; text-align:left;">æ­£ç¢ºå¥å­ï¼š${sentence}</div>
            <br><span style="font-size:14px; color:#555;">(åš´æ ¼æ¨¡å¼ï¼šå¿…é ˆå…¨å°æ‰èƒ½é€²åŒ–ï¼Œè«‹é‡æ–°æŒ‘æˆ°ï¼)</span>
        `;
        
        modal.style.display = 'flex';
    }

    function resetLevel() {
        document.getElementById('error-modal').style.display = 'none';
        loadLevel(); // é‡æ–°è¼‰å…¥
    }

    function nextLevel() {
        currentLevelIdx++;
        if (currentLevelIdx >= levels.length) {
            // å…¨ç ´
            document.querySelector('.left-panel').style.display = 'none';
            document.querySelector('.right-panel').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
            launchConfetti();
        } else {
            loadLevel();
        }
    }

    function launchConfetti() {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#4caf50', '#81c784', '#ffffff']
        });
    }
</script>

</body>
</html>
