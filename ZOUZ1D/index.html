<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°è‘‰å–µé€²åŒ–ï¼šèªè©å¡«ç©ºç‰¹è¨“</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: #2e7d32; /* æ£®æ—ç¶ èƒŒæ™¯ */
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        /* --- å·¦å´ï¼šå¯¶å¯å¤¢å±•ç¤ºå€ (ä½” 40%) --- */
        .left-panel {
            width: 40%;
            height: 100%;
            background: linear-gradient(160deg, #66bb6a 0%, #a5d6a7 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 6px solid #f1f8e9;
            position: relative;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            z-index: 2;
        }

        .poke-img-container {
            width: 90%;
            height: 55%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .poke-img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .poke-info {
            text-align: center;
            color: #1b5e20;
            margin-top: 30px;
        }

        .poke-name {
            font-size: 42px;
            font-weight: 900;
            color: #fff;
            text-shadow: 2px 2px 0 #2e7d32;
            margin: 0;
        }

        .level-indicator {
            font-size: 20px;
            color: #1b5e20;
            margin-top: 15px;
            background: rgba(255,255,255,0.6);
            padding: 6px 20px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- å³å´ï¼šéŠæˆ²å€ (ä½” 60%) --- */
        .right-panel {
            width: 60%;
            height: 100%;
            background-color: #f1f8e9; /* æ¥µæ·ºç¶  */
            display: flex;
            flex-direction: column;
            position: relative;
            background-image: radial-gradient(#dcedc8 10%, transparent 10%);
            background-size: 20px 20px;
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .game-header {
            padding: 20px 30px;
            background: #4caf50;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #388e3c;
        }

        .current-char {
            font-size: 32px;
            font-weight: 900;
            letter-spacing: 2px;
        }

        .instruction {
            font-size: 16px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 12px;
            font-weight: bold;
        }

        /* éŠæˆ²æ²å‹•å€ */
        .game-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* é¡Œç›®å®¹å™¨ (å¥å­æ¡†) */
        .targets-grid {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 20px;
        }

        .sentence-box {
            background: #fff;
            border: 3px solid #81c784;
            border-radius: 18px;
            padding: 18px;
            font-size: 20px;
            color: #33691e;
            line-height: 2;
            position: relative;
            box-shadow: 0 4px 0 #a5d6a7;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        /* æŒ–ç©ºå€åŸŸ (Drop Zone) */
        .drop-zone {
            display: inline-block;
            min-width: 110px;
            height: 38px;
            background: #f1f8e9;
            border-bottom: 3px solid #43a047;
            margin: 0 8px;
            vertical-align: middle;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s;
            padding: 0 5px;
            color: #1b5e20;
            font-weight: bold;
        }

        /* ç­”å°æ¨£å¼ - ä¿®æ”¹è™•ï¼šæ–‡å­—æ”¹ç‚ºæ·±ç¶ è‰² */
        .drop-zone.correct {
            border: none;
            background-color: #a5d6a7; /* èƒŒæ™¯ç¨å¾®æ·ºä¸€é»ï¼Œè®“æ·±è‰²å­—æ›´æ˜é¡¯ */
            color: #003300; /* ä¿®æ”¹ï¼šæ·±ç¶ è‰²æ–‡å­— */
            box-shadow: 0 3px 0 #2e7d32;
            line-height: 38px;
            animation: popIn 0.3s;
        }

        /* ç­”éŒ¯æ¨£å¼ (ç¬é–“) */
        .drop-zone.wrong-flash {
            animation: shake 0.5s;
            background-color: #ffcdd2;
            border-color: #e53935;
        }

        /* é¸é …å€ (èªè©) */
        .options-area {
            background: rgba(255, 255, 255, 0.8);
            border: 3px dashed #66bb6a;
            border-radius: 25px;
            padding: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            min-height: 100px;
        }

        .draggable-item {
            background: #fff;
            color: #2e7d32;
            border: 2px solid #2e7d32;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 22px;
            font-weight: bold;
            cursor: grab;
            box-shadow: 0 5px 0 #1b5e20;
            transition: transform 0.1s;
            touch-action: none;
            z-index: 100;
        }

        .draggable-item:active {
            cursor: grabbing;
            transform: scale(1.1);
            background: #c8e6c9;
        }

        /* æŒ‰éˆ• */
        .next-btn {
            margin: 0 auto;
            padding: 15px 70px;
            font-size: 26px;
            background: #ff7043; /* æ´»åŠ›æ©˜è‰² */
            color: white;
            border: 4px solid #fff;
            border-radius: 50px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 6px 0 #d84315;
            display: none;
            animation: pulseBtn 1.5s infinite;
        }

        /* éŒ¯èª¤æç¤º Modal */
        .error-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .error-content {
            background: white;
            width: 85%;
            max-width: 550px;
            padding: 35px;
            border-radius: 25px;
            text-align: center;
            border-top: 12px solid #e53935;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        .error-title { color: #e53935; font-size: 34px; margin-bottom: 25px; font-weight: 900; }
        .error-msg { font-size: 22px; color: #333; line-height: 1.6; margin-bottom: 35px; text-align: left; background:#fafafa; padding:20px; border-radius:15px; border-left: 6px solid #e53935;}
        .error-btn {
            background: #e53935; color: white; border: none; padding: 15px 45px;
            font-size: 24px; border-radius: 50px; cursor: pointer; font-weight:bold;
            box-shadow: 0 5px 0 #b71c1c;
        }
        .error-btn:active { transform: translateY(4px); box-shadow: none; }

        /* çµæŸç•«é¢ */
        .end-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 3000; color: white;
        }

        /* å‹•ç•« */
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes evolveFlash { 
            0% { filter: brightness(1) drop-shadow(0 0 10px #66bb6a); } 
            50% { filter: brightness(100) drop-shadow(0 0 50px white); } 
            100% { filter: brightness(1) drop-shadow(0 0 10px #66bb6a); } 
        }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* RWD èª¿æ•´ */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .left-panel { width: 100%; height: 35vh; border-right: none; border-bottom: 6px solid #f1f8e9; }
            .right-panel { width: 100%; height: 65vh; }
            .poke-name { font-size: 32px; }
            .game-header { padding: 15px; }
            .current-char { font-size: 26px; }
            .sentence-box { font-size: 18px; padding: 12px; }
            .drop-zone { min-width: 80px; height: 30px; line-height: 30px; }
        }
    </style>
</head>
<body>

    <div class="left-panel">
        <div class="poke-img-container">
            <img src="" id="poke-img" class="poke-img">
        </div>
        <div class="poke-info">
            <h1 class="poke-name" id="poke-name">æ–°è‘‰å–µ</h1>
            <div class="level-indicator" id="stage-indicator">ç¬¬ 1 / 7 é—œ</div>
        </div>
    </div>

    <div class="right-panel">
        <div class="game-header">
            <div class="current-char" id="level-header">ç¬¬ä¸€é—œï¼šæ½®</div>
            <div class="instruction">å°‡èªè©æ‹–å…¥æ­£ç¢ºçš„å¥å­ä¸­ (ç­”éŒ¯éœ€é‡ä¾†)</div>
        </div>

        <div class="game-content">
            <div class="targets-grid" id="targets-grid">
                </div>

            <div class="options-area" id="options-area">
                </div>

            <button class="next-btn" id="next-btn" onclick="nextLevel()">é€²åŒ–ï¼ä¸‹ä¸€é—œ</button>
        </div>
    </div>

    <div class="error-modal" id="error-modal">
        <div class="error-content">
            <div class="error-title">ğŸƒ è‘‰å­æ²’ç„æº–å¥½ï¼</div>
            <div class="error-msg" id="error-msg-text"></div>
            <button class="error-btn" onclick="resetLevel()">é‡æ–°ç‰¹è¨“</button>
        </div>
    </div>

    <div class="end-screen" id="end-screen">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/908.png" style="width:320px; filter: drop-shadow(0 0 30px #66bb6a);">
        <h1 style="color:#66bb6a; font-size:42px; margin-top:20px; text-shadow:2px 2px 0 #000;">åƒè®Šè¬åŒ–ï¼</h1>
        <h2 style="color:#fff;">é­”å¹»å‡é¢å–µ è¯éº—ç™»å ´ï¼</h2>
        <button class="next-btn" style="display:block; background:#fff; color:#2e7d32; margin-top:30px; box-shadow:0 6px 0 #ccc;" onclick="location.reload()">å†æ¬¡æŒ‘æˆ°</button>
    </div>

<script>
    // --- éŠæˆ²è³‡æ–™åº« (7é—œ) ---
    const levels = [
        {
            char: "æ½®",
            pairs: [
                { word: "æ½®æ¿•", sentence: "æœ€è¿‘ä¸€ç›´ä¸‹é›¨ï¼Œé€™ç¨®_____çš„å¤©æ°£è®“è¡£æœéƒ½å¾ˆé›£ä¹¾ã€‚" },
                { word: "æ½®æµ", sentence: "å“¥å“¥æ‰“æ‰®å¾—å¾ˆæ™‚é«¦ï¼Œç¸½æ˜¯èµ°åœ¨æ™‚ä»£çš„_____å°–ç«¯ã€‚" },
                { word: "æ½®æ°´", sentence: "_____é€€å»å¾Œï¼Œæ²™ç˜ä¸Šç•™ä¸‹äº†è¨±å¤šç¾éº—çš„è²æ®¼ã€‚" },
                { word: "æ¼²æ½®", sentence: "_____æ™‚æµ·æ°´æœƒæ·¹æ²’æ²™ç˜ï¼ŒéŠå®¢è¦è¶•å¿«ä¸Šå²¸æ‰å®‰å…¨ã€‚" },
                { word: "é€€æ½®", sentence: "æˆ‘å€‘è¶è‘—_____çš„æ™‚å€™ï¼Œåˆ°æµ·é‚Šè§€å¯Ÿæ‹›æ½®èŸ¹ã€‚" }
            ]
        },
        {
            char: "ç‚¸",
            pairs: [
                { word: "æ²¹ç‚¸", sentence: "å¤šåƒ_____çš„é£Ÿç‰©å®¹æ˜“ç™¼èƒ–ï¼Œé‚„æ˜¯å°‘åƒä¸€é»æ¯”è¼ƒå¥½ã€‚" },
                { word: "ç‚¸è—¥", sentence: "_____æ˜¯éå¸¸å±éšªçš„ç‰©å“ï¼Œä¸å¯ä»¥éš¨ä¾¿é è¿‘ã€‚" },
                { word: "è½Ÿç‚¸", sentence: "é›»å½±è£¡çš„æˆ°æ©Ÿæ­£åœ¨_____æ•µäººçš„åŸºåœ°ã€‚" },
                { word: "ç‚¸é–‹", sentence: "é­ç‚®çªç„¶_____ï¼Œç™¼å‡ºå·¨å¤§çš„è²éŸ¿ï¼Œåš‡äº†æˆ‘ä¸€å¤§è·³ã€‚" }
            ]
        },
        {
            char: "æ—º",
            pairs: [
                { word: "æ—ºç››", sentence: "å°ç‹—çš„ç²¾åŠ›_____ï¼Œåœ¨å…¬åœ’è£¡è·‘å€‹ä¸åœã€‚" },
                { word: "èˆˆæ—º", sentence: "é€™å®¶é¤å»³çš„ç”Ÿæ„éå¸¸_____ï¼Œæ¯å¤©éƒ½é«˜æœ‹æ»¿åº§ã€‚" },
                { word: "æ—ºå­£", sentence: "å¤å¤©æ˜¯å†°åº—çš„_____ï¼Œè€é—†å¿™å¾—ä¸å¯é–‹äº¤ã€‚" }
            ]
        },
        {
            char: "çˆ†",
            pairs: [
                { word: "çˆ†ç™¼", sentence: "å…©åœ‹ä¹‹é–“çªç„¶_____äº†æˆ°çˆ­ï¼Œé€ æˆè¨±å¤šäººæµé›¢å¤±æ‰€ã€‚" },
                { word: "çˆ†è£‚", sentence: "å†¬å¤©å¤ªå†·äº†ï¼Œæ°´ç®¡å®¹æ˜“å› ç‚ºçµå†°è€Œ_____ã€‚" },
                { word: "å¼•çˆ†", sentence: "æ‹†å½ˆå°ˆå®¶æ­£åœ¨å°å¿ƒç¿¼ç¿¼åœ°_____é€™æšæœªçˆ†å½ˆã€‚" },
                { word: "çˆ†æ»¿", sentence: "é€™éƒ¨é›»å½±å¤ªå¥½çœ‹äº†ï¼Œé›»å½±é™¢è£¡å ´å ´_____ã€‚" }
            ]
        },
        {
            char: "æ¢­",
            pairs: [
                { word: "ç©¿æ¢­", sentence: "æœå‹™ç”Ÿåœ¨å¿™ç¢Œçš„é¤å»³è£¡ä¾†å›_____ï¼Œç‚ºå®¢äººé€é¤ã€‚" },
                { word: "å¤ªç©ºæ¢­", sentence: "å¤ªç©ºäººæ­ä¹˜_____é€²å…¥å®‡å®™é€²è¡Œç§‘å­¸å¯¦é©—ã€‚" }
            ]
        },
        {
            char: "å¾µ",
            pairs: [
                { word: "ç‰¹å¾µ", sentence: "é•·é•·çš„é¼»å­æ˜¯å¤§è±¡æœ€æ˜é¡¯çš„_____ã€‚" },
                { word: "å¾µæ±‚", sentence: "è€å¸«_____å¤§å®¶çš„åŒæ„å¾Œï¼Œæ±ºå®šæŠŠç­è²»æçµ¦å­¤å…’é™¢ã€‚" },
                { word: "å¾µå…†", sentence: "ç‡•å­ä½é£›æ˜¯å¤§é›¨å°‡è‡³çš„_____ã€‚" },
                { word: "å¾µæ”¶", sentence: "æ”¿åºœç‚ºäº†æ‹“å¯¬é¦¬è·¯ï¼Œä¾æ³•_____äº†é€™å¡ŠåœŸåœ°ã€‚" },
                { word: "æ‡‰å¾µ", sentence: "å§Šå§Šæº–å‚™å¥½å±¥æ­·è¡¨ï¼Œæ˜å¤©è¦å»_____ä¸€ä»½æ–°çš„å·¥ä½œã€‚" }
            ]
        },
        {
            char: "æš",
            pairs: [
                { word: "è¡¨æš", sentence: "ä»–æ‹¾é‡‘ä¸æ˜§çš„è¡Œç‚ºï¼Œå—åˆ°äº†æ ¡é•·çš„å…¬é–‹_____ã€‚" },
                { word: "å®£æš", sentence: "æˆ‘å€‘è¦åŠªåŠ›_____ç’°ä¿è§€å¿µï¼Œè®“æ›´å¤šäººæ„›è­·åœ°çƒã€‚" },
                { word: "é£„æš", sentence: "é®®è±”çš„åœ‹æ——åœ¨æ“å ´ä¸Šè¿é¢¨_____ã€‚" },
                { word: "è®šæš", sentence: "è§€çœ¾ç†±çƒˆé¼“æŒï¼Œ_____é€™å ´ç²¾å½©çš„éŸ³æ¨‚æœƒã€‚" }
            ]
        }
    ];

    // --- æ–°è‘‰å–µé€²åŒ–è¨­å®š ---
    const stages = [
        // Sprigatito (æ–°è‘‰å–µ)
        { name: "æ–°è‘‰å–µ", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/906.png" },
        // Floragato (è’‚è•¾å–µ)
        { name: "è’‚è•¾å–µ", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/907.png" },
        // Meowscarada (é­”å¹»å‡é¢å–µ)
        { name: "é­”å¹»å‡é¢å–µ", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/908.png" }
    ];

    let currentLevelIdx = 0;
    let matchesFound = 0;

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        loadLevel();
    };

    function loadLevel() {
        const levelData = levels[currentLevelIdx];
        
        // æ›´æ–°æ¨™é¡Œ
        const chineseNums = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ"];
        document.getElementById('level-header').innerText = `ç¬¬${chineseNums[currentLevelIdx]}é—œï¼š${levelData.char}`;
        document.getElementById('stage-indicator').innerText = `ç¬¬ ${currentLevelIdx + 1} / 7 é—œ`;
        document.getElementById('next-btn').style.display = 'none';
        matchesFound = 0;

        // æ›´æ–°å·¦å´å¯¶å¯å¤¢
        updatePokemon();

        // å»ºç«‹é¡Œç›®å€ (Sentences)
        const targetsGrid = document.getElementById('targets-grid');
        targetsGrid.innerHTML = '';
        
        levelData.pairs.forEach(pair => {
            let sentenceBox = document.createElement('div');
            sentenceBox.className = 'sentence-box';
            
            // å°‡å¥å­ä¸­çš„ _____ æ›¿æ›ç‚ºæ”¾ç½®å€ div
            const parts = pair.sentence.split('_____');
            
            let part1 = document.createElement('span');
            part1.innerText = parts[0];
            sentenceBox.appendChild(part1);

            let dropZone = document.createElement('div');
            dropZone.className = 'drop-zone';
            dropZone.dataset.answer = pair.word; // ç­”æ¡ˆ
            // è¨»å†Šæ”¾ç½®äº‹ä»¶
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            sentenceBox.appendChild(dropZone);

            let part2 = document.createElement('span');
            part2.innerText = parts[1];
            sentenceBox.appendChild(part2);
            
            targetsGrid.appendChild(sentenceBox);
        });

        // å»ºç«‹é¸é …å€ (Draggables)
        const optionsArea = document.getElementById('options-area');
        optionsArea.innerHTML = '';
        
        let shuffledPairs = [...levelData.pairs].sort(() => 0.5 - Math.random());
        
        shuffledPairs.forEach(pair => {
            let item = document.createElement('div');
            item.className = 'draggable-item';
            item.draggable = true;
            item.innerText = pair.word;
            
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('touchstart', handleTouchStart, {passive: false});
            item.addEventListener('touchmove', handleTouchMove, {passive: false});
            item.addEventListener('touchend', handleTouchEnd);

            optionsArea.appendChild(item);
        });
    }

    function updatePokemon() {
        const img = document.getElementById('poke-img');
        const nameEl = document.getElementById('poke-name');
        let stage = 0;
        
        // 0-1é—œ: æ–°è‘‰å–µ (2é—œ)
        // 2-4é—œ: è’‚è•¾å–µ (3é—œ)
        // 5-6é—œ: é­”å¹»å‡é¢å–µ (2é—œ)
        if (currentLevelIdx >= 2 && currentLevelIdx < 5) stage = 1;
        if (currentLevelIdx >= 5) stage = 2;

        if (img.src !== stages[stage].img) {
            img.classList.add('evolving');
            setTimeout(() => {
                img.src = stages[stage].img;
                nameEl.innerText = stages[stage].name;
                img.classList.remove('evolving');
            }, 500);
        } else {
            img.src = stages[stage].img;
            nameEl.innerText = stages[stage].name;
        }
    }

    // --- æ‹–æ›³é‚è¼¯ ---
    let draggedItem = null;

    function handleDragStart(e) {
        draggedItem = e.target;
        e.dataTransfer.setData('text/plain', e.target.innerText);
    }

    function handleDragOver(e) {
        e.preventDefault(); 
        if (!e.currentTarget.classList.contains('correct')) {
            e.currentTarget.style.backgroundColor = '#a5d6a7';
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        const box = e.currentTarget;
        if (!box.classList.contains('correct')) {
            box.style.backgroundColor = '#f1f8e9';
        }
        const word = e.dataTransfer.getData('text/plain');
        checkAnswer(box, word, draggedItem);
    }

    // --- è§¸æ§é‚è¼¯ ---
    let touchItem = null;

    function handleTouchStart(e) {
        e.preventDefault();
        touchItem = e.target;
        touchItem.style.position = 'fixed';
        touchItem.style.opacity = '0.8';
        touchItem.style.zIndex = '1000';
        const touch = e.touches[0];
        touchItem.style.left = (touch.clientX - touchItem.offsetWidth / 2) + 'px';
        touchItem.style.top = (touch.clientY - touchItem.offsetHeight / 2) + 'px';
    }

    function handleTouchMove(e) {
        if (!touchItem) return;
        e.preventDefault();
        const touch = e.touches[0];
        touchItem.style.left = (touch.clientX - touchItem.offsetWidth / 2) + 'px';
        touchItem.style.top = (touch.clientY - touchItem.offsetHeight / 2) + 'px';
    }

    function handleTouchEnd(e) {
        if (!touchItem) return;
        const touch = e.changedTouches[0];
        touchItem.style.display = 'none';
        let elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        touchItem.style.display = 'block';

        let box = elemBelow ? elemBelow.closest('.drop-zone') : null;

        if (box) {
            checkAnswer(box, touchItem.innerText, touchItem);
        } else {
            resetItemStyle(touchItem);
        }
        touchItem = null;
    }

    function resetItemStyle(item) {
        item.style.position = 'static';
        item.style.opacity = '1';
        item.style.zIndex = '100';
    }

    // --- æ ¸å¿ƒï¼šæª¢æŸ¥ç­”æ¡ˆ (åš´æ ¼æ¨¡å¼) ---
    function checkAnswer(box, userWord, itemEl) {
        if (box.classList.contains('correct')) {
            if(itemEl.style.position === 'fixed') resetItemStyle(itemEl);
            return;
        }

        const correctWord = box.dataset.answer;

        if (userWord === correctWord) {
            // --- ç­”å° ---
            box.innerText = userWord;
            box.classList.add('correct');
            itemEl.remove();
            
            matchesFound++;
            
            if (matchesFound === levels[currentLevelIdx].pairs.length) {
                launchConfetti();
                document.getElementById('next-btn').style.display = 'block';
            }

        } else {
            // --- ç­”éŒ¯ (è§¸ç™¼é‡ç½®) ---
            if(itemEl.style.position === 'fixed') resetItemStyle(itemEl);
            
            box.classList.add('wrong-flash');
            setTimeout(() => box.classList.remove('wrong-flash'), 500);

            // æŠ“å‡ºæ•´å¥é¡Œç›®
            const fullSentence = box.parentElement.innerText.replace("_____", correctWord).replace(userWord, correctWord);

            showErrorReason(userWord, correctWord, fullSentence);
        }
    }

    function showErrorReason(userWord, correctWord, sentence) {
        const modal = document.getElementById('error-modal');
        const msgText = document.getElementById('error-msg-text');
        
        msgText.innerHTML = `
            ä½ é¸æ“‡äº†ï¼š<span style="color:#e53935; font-weight:bold;">${userWord}</span><br><br>
            ä½†æ­£ç¢ºç­”æ¡ˆæ‡‰è©²æ˜¯ï¼š<span style="color:#2e7d32; font-weight:bold;">${correctWord}</span><br><br>
            <div style="font-size:18px; background:#e8f5e9; padding:15px; border-radius:10px; text-align:left; border-left:4px solid #66bb6a;">æ­£ç¢ºå¥å­ï¼š${sentence}</div>
            <br><span style="font-size:15px; color:#555;">(åš´æ ¼ç‰¹è¨“ï¼šå¿…é ˆä¸€æ¬¡å…¨å°æ‰èƒ½é€²åŒ–ï¼Œè«‹é‡æ–°æŒ‘æˆ°ï¼)</span>
        `;
        
        modal.style.display = 'flex';
    }

    function resetLevel() {
        document.getElementById('error-modal').style.display = 'none';
        loadLevel(); // é‡æ–°è¼‰å…¥
    }

    function nextLevel() {
        currentLevelIdx++;
        if (currentLevelIdx >= levels.length) {
            // å…¨ç ´
            document.querySelector('.left-panel').style.display = 'none';
            document.querySelector('.right-panel').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
            launchConfetti();
        } else {
            loadLevel();
        }
    }

    function launchConfetti() {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#66bb6a', '#a5d6a7', '#ff7043', '#ffffff']
        });
    }
</script>

</body>
</html>
